<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ES-MALL - Shopping Cart Management System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --sidebar-width: 240px;
            --sidebar-bg: #0f172a;
            --sidebar-hover: #1e293b;
            --sidebar-active: #3730a3;
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #f1f5f9;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-light: #94a3b8;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --radius: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
            background-color: var(--bg-secondary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Layout */
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .logo i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }

        .nav-section {
            padding: 0 1rem;
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            color: var(--text-light);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            padding: 0 0.75rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            color: #cbd5e1;
            text-decoration: none;
            border-radius: var(--radius);
            transition: all 0.2s ease;
            margin-bottom: 0.25rem;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.875rem;
        }

        .nav-item:hover {
            background: var(--sidebar-hover);
            color: white;
        }

        .nav-item.active {
            background: var(--sidebar-active);
            color: white;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 1rem;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--primary);
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            color: white;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Bar */
        .topbar {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .breadcrumb-separator {
            color: var(--text-light);
        }

        .breadcrumb-active {
            color: var(--text-primary);
            font-weight: 500;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .topbar-button {
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .topbar-button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: var(--bg-secondary);
        }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            padding: 1.25rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--primary);
        }

        .stat-content {
            flex: 1;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Grid Layout */
        .grid-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Card */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .product-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .product-icon {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .product-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .product-price {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Cart Items */
        .cart-items {
            max-height: 400px;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
            background: var(--bg-secondary);
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .cart-item-price {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-btn {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border);
            background: white;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .quantity-btn:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .quantity-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quantity-display {
            min-width: 2rem;
            text-align: center;
            font-weight: 500;
        }

        /* Cart Total */
        .cart-total {
            border-top: 2px solid var(--border);
            padding-top: 1rem;
            margin-top: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .total-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .total-amount {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Cart Actions */
        .cart-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn {
            flex: 1;
            padding: 0.625rem 1rem;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Event Log */
        .event-log {
            background: white;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            margin-top: 1.5rem;
        }

        .event-items {
            max-height: 300px;
            overflow-y: auto;
            padding: 1rem;
        }

        .event-item {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
            background: var(--bg-secondary);
        }

        .event-type {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .event-data {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .event-timestamp {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-light);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .empty-state p {
            font-size: 0.875rem;
        }

        /* Alert */
        .alert {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            color: white;
            font-weight: 500;
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .alert.success {
            background: var(--success);
        }

        .alert.error {
            background: var(--error);
        }

        .alert.warning {
            background: var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -var(--sidebar-width);
                z-index: 100;
                transition: left 0.3s ease;
            }

            .sidebar.open {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }

            .stats-row {
                grid-template-columns: 1fr;
            }

            .grid-container {
                grid-template-columns: 1fr;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* History Section */
        .history-grid {
            display: grid;
            gap: 1rem;
        }

        .history-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .history-item:hover {
            background: white;
            box-shadow: var(--shadow-md);
        }

        .history-item.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .history-info {
            flex: 1;
        }

        .history-id {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .history-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.opened {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .status-badge.confirmed {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-badge.cancelled {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-shopping-cart"></i>
                    <span>ES-MALL</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">메인</div>
                    <button class="nav-item active" onclick="switchView('dashboard')">
                        <i class="fas fa-home"></i>
                        <span>대시보드</span>
                    </button>
                    <button class="nav-item" onclick="switchView('products')">
                        <i class="fas fa-box"></i>
                        <span>상품 관리</span>
                        <span class="nav-badge" id="productCount">0</span>
                    </button>
                    <button class="nav-item" onclick="switchView('cart')">
                        <i class="fas fa-shopping-cart"></i>
                        <span>장바구니</span>
                        <span class="nav-badge" id="cartItemCount">0</span>
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">히스토리</div>
                    <button class="nav-item" onclick="switchView('history')">
                        <i class="fas fa-history"></i>
                        <span>주문 내역</span>
                    </button>
                    <button class="nav-item" onclick="switchView('events')">
                        <i class="fas fa-database"></i>
                        <span>이벤트 로그</span>
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">설정</div>
                    <button class="nav-item" onclick="switchView('settings')">
                        <i class="fas fa-cog"></i>
                        <span>시스템 설정</span>
                    </button>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">A</div>
                    <div class="user-details">
                        <div class="user-name">Admin User</div>
                        <div class="user-role">관리자</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="topbar">
                <div class="topbar-left">
                    <div class="breadcrumb">
                        <span>홈</span>
                        <span class="breadcrumb-separator">/</span>
                        <span class="breadcrumb-active" id="currentPage">대시보드</span>
                    </div>
                </div>
                <div class="topbar-right">
                    <button class="topbar-button" onclick="createCart()">
                        <i class="fas fa-plus"></i>
                        새 장바구니
                    </button>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content">
                <!-- Dashboard View -->
                <div id="dashboardView" class="tab-content active">
                    <!-- Stats Row -->
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">총 장바구니</div>
                                <div class="stat-value" id="totalCarts">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">확정된 주문</div>
                                <div class="stat-value" id="confirmedCarts">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">등록 상품</div>
                                <div class="stat-value" id="totalProducts">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">총 이벤트</div>
                                <div class="stat-value" id="totalEvents">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Grid -->
                    <div class="grid-container">
                        <!-- Products Section -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-store"></i>
                                    상품 목록
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="products-grid" id="products">
                                    <!-- Products will be loaded here -->
                                </div>
                            </div>
                        </div>

                        <!-- Cart Section -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-shopping-bag"></i>
                                    현재 장바구니
                                </h3>
                                <span class="status-badge opened" id="cartStatus">새 카트</span>
                            </div>
                            <div class="card-body">
                                <div id="cartContent">
                                    <div class="empty-state">
                                        <i class="fas fa-shopping-cart"></i>
                                        <h3>장바구니가 비어있습니다</h3>
                                        <p>상품을 클릭하여 추가하세요</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Events -->
                    <div class="event-log">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-clock"></i>
                                최근 이벤트
                            </h3>
                        </div>
                        <div class="event-items" id="recentEvents">
                            <div class="empty-state">
                                <i class="fas fa-database"></i>
                                <h3>이벤트가 없습니다</h3>
                                <p>활동이 시작되면 여기에 표시됩니다</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products View -->
                <div id="productsView" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-box"></i>
                                상품 관리
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="products-grid" id="productsManagement">
                                <!-- Products will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cart View -->
                <div id="cartView" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-shopping-cart"></i>
                                장바구니 관리
                            </h3>
                            <span class="status-badge opened" id="cartStatusDetail">새 카트</span>
                        </div>
                        <div class="card-body">
                            <div id="cartDetailContent">
                                <div class="empty-state">
                                    <i class="fas fa-shopping-cart"></i>
                                    <h3>장바구니가 비어있습니다</h3>
                                    <p>상품을 추가하여 시작하세요</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History View -->
                <div id="historyView" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-history"></i>
                                주문 내역
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="history-grid" id="cartHistory">
                                <div class="empty-state">
                                    <i class="fas fa-archive"></i>
                                    <h3>저장된 장바구니가 없습니다</h3>
                                    <p>장바구니를 생성하면 여기에 표시됩니다</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Events View -->
                <div id="eventsView" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-database"></i>
                                이벤트 로그
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="event-items" id="eventHistory">
                                <div class="empty-state">
                                    <i class="fas fa-database"></i>
                                    <h3>이벤트가 없습니다</h3>
                                    <p>시스템 이벤트가 여기에 기록됩니다</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings View -->
                <div id="settingsView" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-cog"></i>
                                시스템 설정
                            </h3>
                        </div>
                        <div class="card-body">
                            <p>시스템 설정 페이지입니다.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Alert -->
    <div id="alert" class="alert"></div>

    <script>
        let currentCart = null;
        let products = [];
        let cartHistory = [];
        let eventHistory = [];
        let selectedCartId = null;

        // Load products
        async function loadProducts() {
            try {
                const response = await fetch('/api');
                const data = await response.json();
                products = data.sampleProducts.map((p, index) => ({
                    ...p,
                    productName: getProductName(index)
                }));
                renderProducts();
                updateStats();
            } catch (error) {
                showAlert('상품을 불러오는데 실패했습니다', 'error');
            }
        }

        function getProductName(index) {
            const names = ['노트북', '마우스', '키보드', '모니터', '헤드셋'];
            return names[index] || `상품 ${index + 1}`;
        }

        function getProductIcon(index) {
            const icons = ['fas fa-laptop', 'fas fa-computer-mouse', 'fas fa-keyboard', 'fas fa-desktop', 'fas fa-headphones'];
            return icons[index] || 'fas fa-shopping-bag';
        }

        function renderProducts() {
            const productHTML = products.map((product, index) => `
                <div class="product-card" onclick="addToCart('${product.productId}', '${product.productName}', ${product.price})">
                    <i class="product-icon ${getProductIcon(index)}"></i>
                    <div class="product-name">${product.productName}</div>
                    <div class="product-price">$${product.price}</div>
                </div>
            `).join('');

            document.getElementById('products').innerHTML = productHTML;
            document.getElementById('productsManagement').innerHTML = productHTML;
            document.getElementById('productCount').textContent = products.length;
        }

        // Create cart
        async function createCart() {
            try {
                const response = await fetch('/api/carts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (!response.ok) throw new Error('Failed to create cart');

                const data = await response.json();
                currentCart = {
                    id: data.id,
                    status: data.status,
                    items: [],
                    revision: data.revision
                };

                showAlert('새 장바구니가 생성되었습니다', 'success');
                renderCart();
                loadCartHistory();
                loadEventHistory();
            } catch (error) {
                showAlert('장바구니 생성에 실패했습니다', 'error');
            }
        }

        // Add to cart
        async function addToCart(productId, productName, price) {
            if (!currentCart || currentCart.status !== 'Opened') {
                showAlert('먼저 새 장바구니를 만들어주세요', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/carts/${currentCart.id}/items`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'If-Match': currentCart.revision
                    },
                    body: JSON.stringify({
                        productId,
                        productName,
                        quantity: 1
                    })
                });

                if (!response.ok) throw new Error('Failed to add item');

                await loadCartFromServer(currentCart.id);
                showAlert(`${productName}이(가) 추가되었습니다`, 'success');
                renderCart();
                loadEventHistory();
            } catch (error) {
                showAlert('상품 추가에 실패했습니다', 'error');
            }
        }

        // Remove from cart
        async function removeFromCart(productId) {
            if (!currentCart || currentCart.status !== 'Opened') return;

            try {
                const response = await fetch(`/api/carts/${currentCart.id}/items/${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'If-Match': currentCart.revision
                    },
                    body: JSON.stringify({ quantity: 1 })
                });

                if (!response.ok) throw new Error('Failed to remove item');

                await loadCartFromServer(currentCart.id);
                renderCart();
                loadEventHistory();
            } catch (error) {
                showAlert('상품 제거에 실패했습니다', 'error');
            }
        }

        // Confirm cart
        async function confirmCart() {
            if (!currentCart || currentCart.status !== 'Opened') return;

            try {
                const response = await fetch(`/api/carts/${currentCart.id}/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'If-Match': currentCart.revision
                    }
                });

                if (!response.ok) throw new Error('Failed to confirm cart');

                const data = await response.json();
                currentCart.status = 'Confirmed';
                currentCart.revision = data.revision;

                showAlert('장바구니가 확정되었습니다', 'success');
                renderCart();
                loadCartHistory();
                loadEventHistory();
            } catch (error) {
                showAlert('장바구니 확정에 실패했습니다', 'error');
            }
        }

        // Cancel cart
        async function cancelCart() {
            if (!currentCart || currentCart.status !== 'Opened') return;

            try {
                const response = await fetch(`/api/carts/${currentCart.id}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'If-Match': currentCart.revision
                    }
                });

                if (!response.ok) throw new Error('Failed to cancel cart');

                const data = await response.json();
                currentCart.status = 'Cancelled';
                currentCart.revision = data.revision;

                showAlert('장바구니가 취소되었습니다', 'success');
                renderCart();
                loadCartHistory();
                loadEventHistory();
            } catch (error) {
                showAlert('장바구니 취소에 실패했습니다', 'error');
            }
        }

        // Load cart from server
        async function loadCartFromServer(cartId) {
            const response = await fetch(`/api/carts/${cartId}`);
            if (!response.ok) throw new Error('Failed to load cart');

            const data = await response.json();
            currentCart = {
                id: data.id,
                status: data.status,
                items: data.items ? data.items.map(item => ({
                    productId: item.productId,
                    productName: item.productName,
                    price: item.unitPrice,
                    quantity: item.quantity
                })) : [],
                revision: data.revision
            };
        }

        // Load specific cart
        async function loadCart(cartId) {
            try {
                await loadCartFromServer(cartId);
                renderCart();
                showAlert('장바구니를 불러왔습니다', 'success');
            } catch (error) {
                showAlert('장바구니를 불러오는데 실패했습니다', 'error');
            }
        }

        // Render cart
        function renderCart() {
            const containers = ['cartContent', 'cartDetailContent'];
            const statusElements = ['cartStatus', 'cartStatusDetail'];

            containers.forEach((containerId, index) => {
                const container = document.getElementById(containerId);
                const statusEl = document.getElementById(statusElements[index]);

                if (!currentCart || currentCart.items.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-shopping-cart"></i>
                            <h3>장바구니가 비어있습니다</h3>
                            <p>상품을 클릭하여 추가하세요</p>
                        </div>
                    `;
                    statusEl.textContent = '새 카트';
                    statusEl.className = 'status-badge opened';
                } else {
                    const total = currentCart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    const itemCount = currentCart.items.reduce((sum, item) => sum + item.quantity, 0);

                    statusEl.textContent = currentCart.status === 'Opened' ? '진행중' :
                        currentCart.status === 'Confirmed' ? '확정됨' : '취소됨';
                    statusEl.className = `status-badge ${currentCart.status.toLowerCase()}`;

                    container.innerHTML = `
                        <div class="cart-items">
                            ${currentCart.items.map(item => `
                                <div class="cart-item">
                                    <div class="cart-item-info">
                                        <div class="cart-item-name">${item.productName}</div>
                                        <div class="cart-item-price">$${item.price} × ${item.quantity}</div>
                                    </div>
                                    <div class="quantity-control">
                                        <button class="quantity-btn" onclick="removeFromCart('${item.productId}')"
                                                ${currentCart.status !== 'Opened' ? 'disabled' : ''}>
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <span class="quantity-display">${item.quantity}</span>
                                        <button class="quantity-btn" onclick="addToCart('${item.productId}', '${item.productName}', ${item.price})"
                                                ${currentCart.status !== 'Opened' ? 'disabled' : ''}>
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="cart-total">
                            <div class="total-label">총 ${itemCount}개 상품</div>
                            <div class="total-amount">$${total.toFixed(2)}</div>
                        </div>
                        ${currentCart.status === 'Opened' ? `
                            <div class="cart-actions">
                                <button class="btn btn-success" onclick="confirmCart()">
                                    <i class="fas fa-check"></i>
                                    확정
                                </button>
                                <button class="btn btn-danger" onclick="cancelCart()">
                                    <i class="fas fa-times"></i>
                                    취소
                                </button>
                            </div>
                        ` : ''}
                    `;
                }
            });

            // Update cart item count
            const itemCount = currentCart ? currentCart.items.reduce((sum, item) => sum + item.quantity, 0) : 0;
            document.getElementById('cartItemCount').textContent = itemCount;
        }

        // Load cart history
        async function loadCartHistory() {
            try {
                const response = await fetch('/api/carts');
                if (response.ok) {
                    cartHistory = await response.json();
                    renderCartHistory();
                    updateStats();
                }
            } catch (error) {
                console.warn('Failed to load cart history:', error);
            }
        }

        // Render cart history
        function renderCartHistory() {
            const container = document.getElementById('cartHistory');

            if (cartHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-archive"></i>
                        <h3>저장된 장바구니가 없습니다</h3>
                        <p>장바구니를 생성하면 여기에 표시됩니다</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = cartHistory.map(cart => {
                const total = cart.items.reduce((sum, item) => sum + ((item.unitPrice || item.price) * item.quantity), 0);
                const itemCount = cart.items.reduce((sum, item) => sum + item.quantity, 0);
                const date = new Date(cart.openedAt || cart.lastUpdated).toLocaleString('ko-KR');

                return `
                    <div class="history-item ${selectedCartId === cart.id ? 'selected' : ''}" onclick="loadCart('${cart.id}')">
                        <div class="history-info">
                            <div class="history-id">장바구니 #${cart.id.slice(0, 8)}</div>
                            <div class="history-meta">
                                ${itemCount}개 상품 • $${total.toFixed(2)} • ${date}
                            </div>
                        </div>
                        <span class="status-badge ${cart.status.toLowerCase()}">
                            ${cart.status === 'Opened' ? '진행중' :
                        cart.status === 'Confirmed' ? '확정됨' : '취소됨'}
                        </span>
                    </div>
                `;
            }).reverse().join('');
        }

        // Load event history
        async function loadEventHistory() {
            try {
                const response = await fetch('/api/events');
                if (response.ok) {
                    eventHistory = await response.json();
                    renderEventHistory();
                    updateStats();
                }
            } catch (error) {
                console.warn('Failed to load event history:', error);
            }
        }

        // Render event history
        function renderEventHistory() {
            const containers = ['recentEvents', 'eventHistory'];

            containers.forEach(containerId => {
                const container = document.getElementById(containerId);

                if (eventHistory.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-database"></i>
                            <h3>이벤트가 없습니다</h3>
                            <p>활동이 시작되면 여기에 표시됩니다</p>
                        </div>
                    `;
                    return;
                }

                let allEvents = eventHistory.flatMap(stream =>
                    stream.events.map(event => ({
                        ...event,
                        streamId: stream.streamId
                    }))
                );

                // Sort by timestamp
                allEvents.sort((a, b) => new Date(b.data.addedAt || b.data.openedAt || 0) - new Date(a.data.addedAt || a.data.openedAt || 0));

                // Limit recent events to 10
                if (containerId === 'recentEvents') {
                    allEvents = allEvents.slice(0, 10);
                }

                container.innerHTML = allEvents.map(event => {
                    const timestamp = new Date(event.data.addedAt || event.data.openedAt || event.data.confirmedAt || event.data.cancelledAt).toLocaleString('ko-KR');

                    let eventData = '';
                    if (event.type === 'ShoppingCartOpened') {
                        eventData = `장바구니 생성`;
                    } else if (event.type === 'ProductItemAddedToShoppingCart') {
                        eventData = `${event.data.productItem.productName} 추가 (${event.data.productItem.quantity}개)`;
                    } else if (event.type === 'ProductItemRemovedFromShoppingCart') {
                        eventData = `${event.data.productItem.productName} 제거 (${event.data.productItem.quantity}개)`;
                    } else if (event.type === 'ShoppingCartConfirmed') {
                        eventData = `장바구니 확정`;
                    } else if (event.type === 'ShoppingCartCancelled') {
                        eventData = `장바구니 취소`;
                    }

                    return `
                        <div class="event-item">
                            <div class="event-type">${event.type}</div>
                            <div class="event-data">${eventData}</div>
                            <div class="event-timestamp">${timestamp}</div>
                        </div>
                    `;
                }).join('');
            });
        }

        // Update stats
        function updateStats() {
            document.getElementById('totalCarts').textContent = cartHistory.length;
            document.getElementById('confirmedCarts').textContent = cartHistory.filter(c => c.status === 'Confirmed').length;
            document.getElementById('totalProducts').textContent = products.length;

            const totalEvents = eventHistory.reduce((sum, stream) => sum + stream.events.length, 0);
            document.getElementById('totalEvents').textContent = totalEvents;
        }

        // Switch view
        function switchView(viewName) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');

            // Update views
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${viewName}View`).classList.add('active');

            // Update breadcrumb
            const breadcrumbText = {
                dashboard: '대시보드',
                products: '상품 관리',
                cart: '장바구니',
                history: '주문 내역',
                events: '이벤트 로그',
                settings: '시스템 설정'
            };
            document.getElementById('currentPage').textContent = breadcrumbText[viewName];
        }

        // Show alert
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        // Initialize
        async function init() {
            await loadProducts();
            loadCartHistory();
            loadEventHistory();
        }

        init();
    </script>
</body>

</html>